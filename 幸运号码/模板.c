#include <reg52.h>
#include <intrins.h>
#include <stdlib.h>
typedef unsigned int u16;
typedef unsigned char u8;
sbit RCLK_=P3^5;
sbit SRCLK=P3^6;
sbit SER=P3^4;
u16 flag=0;  //用于判断按键是否被按下
u8 code point[][2]={{0x7f,0x80},{0xbf,0x80},{0xdf,0x80},{0xef,0x80},{0xf7,0x80},{0xfb,0x80},{0xfd,0x80},{0xfe,0x80},
										{0x7f,0x40},{0xbf,0x40},{0xdf,0x40},{0xef,0x40},{0xf7,0x40},{0xfb,0x40},{0xfd,0x40},{0xfe,0x40},
										{0x7f,0x20},{0xbf,0x20},{0xdf,0x20},{0xef,0x20},{0xf7,0x20},{0xfb,0x20},{0xfd,0x20},{0xfe,0x20},
										{0x7f,0x10},{0xbf,0x10},{0xdf,0x10},{0xef,0x10},{0xf7,0x10},{0xfb,0x10},{0xfd,0x10},{0xfe,0x10},
										{0x7f,0x08},{0xbf,0x08},{0xdf,0x08},{0xef,0x08},{0xf7,0x08},{0xfb,0x08},{0xfd,0x08},{0xfe,0x08},
										{0x7f,0x04},{0xbf,0x04},{0xdf,0x04},{0xef,0x04},{0xf7,0x04},{0xfb,0x04},{0xfd,0x04},{0xfe,0x04},
										{0x7f,0x02},{0xbf,0x02},{0xdf,0x02},{0xef,0x02},{0xf7,0x02},{0xfb,0x02},{0xfd,0x02},{0xfe,0x02},
										{0x7f,0x01},{0xbf,0x01},{0xdf,0x01},{0xef,0x01},{0xf7,0x01},{0xfb,0x01},{0xfd,0x01},{0xfe,0x01}};

u8 P0duan[]={0x7f,0xbf,0xdf,0xef,0xf7,0xfb,0xfd,0xfe};
u8 code list[][8]={{0x00,0x3c,0x42,0x81,0x81,0x42,0x3c,0x00},
									 {0x00,0x02,0x02,0x42,0xfe,0x02,0x02,0x00},
									 {0x00,0x22,0x46,0x8a,0x52,0x22,0x02,0x00},
									 {0x00,0x00,0x42,0x81,0x89,0x89,0x77,0x00},
									 {0x00,0x18,0x28,0x48,0xff,0x08,0x08,0x00},
									 {0x00,0x71,0x89,0x89,0x89,0x8e,0x00,0x00},
									 {0x00,0x3e,0x51,0x91,0x91,0x0e,0x00,0x00},
									 {0x00,0x80,0x80,0x9f,0xa0,0xc0,0x80,0x00},
									 {0x00,0x76,0x89,0x89,0x89,0x76,0x00,0x00},
									 {0x00,0x72,0x89,0x89,0x89,0x7f,0x00,0x00}};
void delay(u16 i)
{
	while(i--);
}

void hc595byte(u8 dat)   //作用是给点阵的阳极高低电平
{
	u16 i;
	RCLK_=0;
	SRCLK=0;
	for(i=0;i<8;i++)   //一位位将data送入移位寄存器，先高位，后低位
	{
		SER=dat>>7;   //取最高位
		dat=dat<<1;   //移去最高位，最低位补0
		SRCLK=1;   //移位寄存器，产生一个上升沿，将SER的数据移入移位寄存器
		_nop_();   //延时
		_nop_();
		SRCLK=0;   //归零，以便再次产生上升沿
	}
	RCLK_=1;   //存储寄存器产生上升沿，将SER已移入的数据送给输出端
}

void open_point(u16 pos)  //传递某一点在点阵中的位置，点亮某一点
{
	P0=point[pos][0];
	hc595byte(point[pos][1]);
}

void Init_Ex0()
{
	EA=1;
	EX0=1;
	IT0=1;
}
void main()
{
	u16 i;
	Init_Ex0();
	while(1)
	{
		u16 point_random=rand()%64;
	  open_point(point_random);
		if(flag==1)
		{
			point_random=rand()%10;
			while(1)
			{
				for(i=0;i<8;i++)
				{
					P0=P0duan[i];
					hc595byte(list[point_random][i]);
					delay(100);
					hc595byte(0x00);
				}
			}
		}
	}
}
void ex0() interrupt 0
{
	flag=1;
}